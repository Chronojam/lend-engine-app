<?php

namespace AppBundle\Repository;

/**
 * MembershipRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class MembershipRepository extends \Doctrine\ORM\EntityRepository
{

    /**
     * This function gets the data required to feed the contact list DataTable via AJAX
     * @param $search
     * @param $start
     * @param $length
     * @return array
     */
    public function search($start, $length, $search)
    {
        $repository = $this->getEntityManager()->getRepository('AppBundle:Membership');

        $builder = $repository->createQueryBuilder('s');
        $builder->select('s, c');
        $builder->leftJoin('s.contact', 'c');
        $builder->leftJoin('s.membershipType', 'mt');

        if ($search) {
            $builder->andWhere('c.firstName LIKE :string');
            $builder->orWhere('c.lastName LIKE :string');
            $builder->orWhere('c.email LIKE :string');
            $builder->orWhere('s.status LIKE :string');
            $builder->orWhere('mt.name LIKE :string');
            $builder->setParameter('string', '%'.$search.'%');
        }

        $builder->setFirstResult($start);
        $builder->setMaxResults($length);
        $builder->addOrderBy("s.createdAt", "DESC");

        $query = $builder->getQuery();

        return $query->getResult();
    }

    /**
     * @return integer
     */
    public function countAll()
    {
        $repository = $this->getEntityManager()->getRepository('AppBundle:Membership');
        $builder = $repository->createQueryBuilder('c');
        $builder->add('select', 'COUNT(c) AS qty');
        $query = $builder->getQuery();
        if ( $results = $query->getResult() ) {
            $total = $results[0]['qty'];
        } else {
            $total = 0;
        }
        return $total;
    }

    /**
     * @return array|bool
     * Called from update route
     */
    public function getExpiredMemberships()
    {
        $repository = $this->getEntityManager()->getRepository('AppBundle:Membership');
        $qb = $repository->createQueryBuilder('m');
        $qb->select('m')
            ->where('m.expiresAt < :date')
            ->andWhere('m.status = :statusActive')
            ->setParameter('date', new \DateTime())
            ->setParameter('statusActive', 'ACTIVE');

        $query = $qb->getQuery();

        if ( $results = $query->getResult() ) {
            return $results;
        } else {
            return false;
        }
    }

    /**
     * Called when user logs in
     */
    public function activatePendingMemberships()
    {
        // Activate pending memberships
        $qb = $this->getEntityManager()->createQueryBuilder();
        $q = $qb->update('AppBundle:Membership', 'm')
            ->set('m.status', ':statusActive')
            ->where('m.startsAt < :date')
            ->andWhere('m.status = :statusPending')
            ->setParameter('date', new \DateTime())
            ->setParameter('statusPending', 'PENDING')
            ->setParameter('statusActive', 'ACTIVE')
            ->getQuery();
        $q->execute();
    }

}
