<?php

namespace AppBundle\Repository;

/**
 * OpeningTimeExceptionRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OpeningTimeExceptionRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @return array
     */
    public function search($filter)
    {
        $repository = $this->getEntityManager()->getRepository('AppBundle:OpeningTimeException');
        $builder = $repository->createQueryBuilder('o');

        $builder->add('select', 'o');

        if (isset($filter['from'])) {
            $builder->andWhere("o.date >= '".$filter['from']."'");
        }

        if (isset($filter['to'])) {
            $builder->andWhere("o.date <= '".$filter['to']."'");
        }

        if (isset($filter['site_id'])) {
            $builder->andWhere("o.site = '".$filter['site_id']."'");
        }

        $query = $builder->getQuery();
        return $query->getResult();
    }

    /**
     * Fired each time someone logs in
     */
    public function removeHistoricOpeningHours()
    {
        $em = $this->getEntityManager();

        $today = new \DateTime();
        $today->modify("-30 day");
        $filter = ['to' => $today->format("Y-m-d")];
        $o = $this->search($filter);
        foreach ($o AS $s) {
            $em->remove($s);
        }
        $em->flush();
    }
}
