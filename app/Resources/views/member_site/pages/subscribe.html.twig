{% extends 'member_site/themes/loader.html.twig' %}
{% trans_default_domain 'member_site' %}

{% block search %}
    {{ include('member_site/partials/search.html.twig') }}
{% endblock %}

{% block body %}
    <style>
        .membership-type {
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fafafa;
            padding: 15px;
        }
        .membership-type:hover {
            background-color: #eaeaea;
            border: 1px solid black;
        }
    </style>
    <h2>
        {% trans %}Subscribe{% endtrans %}
    </h2>

    <div class="row">

        {% if app.user.activeMembership is defined and app.user.activeMembership and app.user.activeMembership.status == 'ACTIVE' %}
            <div class="col-md-12">
                <div class="alert alert-info">
                    You are currently a <strong>{{ app.user.activeMembership.membershipType.name }}</strong> member.<br>
                    Your membership expires on {{ app.user.activeMembership.expiresAt|date("D j F Y") }}
                </div>
            </div>
        {% endif %}

        {% if membershipTypes|length > 0 %}

            <form method="POST" class="payment-form" id="subsForm">

                <input type="hidden" name="paymentMethodId" value="{{ tenantInformation.stripePaymentMethodId }}" class="payment-method">
                <input type="hidden" name="customerEmail" value="{{ app.user.email }}" class="contact-email">
                <input type="hidden" name="stripeToken" value="" class="stripe-token">
                <input type="hidden" name="membershipTypeId" id="membershipTypeId" value="">
                <input type="hidden" name="paymentAmount" class="payment-amount" id="paymentAmount" value="">

        {% for membershipType in membershipTypes %}

            <div class="col-md-4">

                <div class="membership-type">

                    <h4>{{ membershipType.name }}</h4>
                    <div>
                        {{ tenantInformation.currencySymbol }} {{ membershipType.price }}
                    </div>
                    <div>
                        {{ membershipType.duration }} days
                    </div>
                    <div>
                        {% if membershipType.discount > 0 %}
                            {{ membershipType.discount|number_format() }}% discount on loan fees.
                        {% else %}
                            &nbsp;
                        {% endif %}
                    </div>

                        <div>
                            <br><br>
                            <button type="submit" id="{{ membershipType.id }}" data-amount="{{ membershipType.price }}" class="btn btn-success {% if membershipType.price > 0 %}payment-submit{% else %}subscribe-submit{% endif %}">
                                {% if app.user.activeMembership is defined
                                and app.user.activeMembership
                                and app.user.activeMembership.status == 'ACTIVE'
                                and app.user.activeMembership.membershipType == membershipType %}Renew membership{% else %}Subscribe{% endif %}
                            </button>

                            <br><br>
                            <div class="help-block">
                            {% if app.user.activeMembership is defined
                            and app.user.activeMembership
                            and app.user.activeMembership.status == 'ACTIVE'
                            and app.user.activeMembership.membershipType == membershipType
                                and app.user.activeMembership.expiresAt|date("Y-m-d") < date()|date_modify("+14 days")|date("Y-m-d")
                            %}
                                Your membership will be renewed from <strong>{{ app.user.activeMembership.expiresAt|date("j F Y") }}</strong>.
                            {% else %}
                                Your new membership will start today.
                            {% endif %}
                            </div>
                        </div>
                        <br>

                    <div class="help-block">
                        {{ membershipType.description|nl2br }}
                    </div>

                </div>

            </div>

        {% endfor %}

            </form>

        {% else %}
            <div class="col-md-12">
                <div class="alert alert-warning">
                    There are no memberships available for self serve subscription.<br>
                    Please come in to visit us with photo ID to complete your membership.
                </div>
            </div>
        {% endif %}
    </div>

{% endblock %}

{% block pagejs %}
    <script>

        {#var subscriptionHandler = StripeCheckout.configure({#}
            {#key: stripePublicApiKey,#}
            {#locale: 'auto',#}
            {#token: function(token) {#}
                {#$("#stripeToken").val(token.id);#}
                {#$("#subsForm").submit();#}
{#//                waitButton($('.subscribe-submit'));#}
            {#}#}
        {#});#}

        {#// When user clicks payment button, route through Stripe if appropriate#}
        $(document).on('click', ".subscribe-submit, .payment-submit", function(e) {

            var paymentAmount = $(this).data('amount');
            var membershipTypeId = $(this).attr('id');
            $("#membershipTypeId").val(membershipTypeId);
            $("#paymentAmount").val(paymentAmount);

            {#// Open Checkout with further options:#}
            {#subscriptionHandler.open({#}
                {#name: '{{ tenantInformation.companyName }}',#}
                {#zipCode: false,#}
                {#amount: paymentAmount * 100#}
                {#currency: 'gbp',#}
                {#allowRememberMe: false,#}
                {#email:  '{{ app.user.email }}',#}
                {#label: 'Pay {{ tenantInformation.currencySymbol }} : '+paymentAmount#}
            {#});#}
            {#e.preventDefault();#}

        });
    </script>
{% endblock %}