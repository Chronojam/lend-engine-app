{# app/Resources/views/loan/loan_list.html.twig #}
{% extends 'base.html.twig' %}

{% block pageCss %}
{% endblock %}

{% block title %}Loans{% endblock %}

{% block pageTitle %}Loans{% endblock %}

{% block primaryButton %}

    <span class="secondary-link {% if app.request.get('status') == "RESERVED" %}active{% endif %}">
    {% if countReserved > 0 %}
        <div class="label bg-orange">{{ countReserved }}</div> <a href="{{ path('loan_list', { status: "RESERVED" }) }}">Reserved</a>
    {% else %}
        <div class="label bg-gray">0</div> <a href="{{ path('loan_list', { status: "RESERVED" }) }}">Reserved</a>
    {% endif %}
    </span>

    <span class="secondary-link {% if app.request.get('status') == "PENDING" %}active{% endif %}">
    {% if countPending > 0 %}
        <div class="label bg-gray">{{ countPending }}</div> <a href="{{ path('loan_list', { status: "PENDING" }) }}">Pending</a>
    {% else %}
        <div class="label bg-gray">0</div> <a href="{{ path('loan_list', { status: "PENDING" }) }}">Pending</a>
    {% endif %}
    </span>

    <span class="secondary-link {% if app.request.get('status') == "ACTIVE" %}active{% endif %}">
    {% if countActive > 0 %}
        <div class="label bg-teal">{{ countActive }}</div> <a href="{{ path('loan_list', { status: "ACTIVE" }) }}">On loan</a>
    {% else %}
        <div class="label bg-gray">0</div> <a href="{{ path('loan_list', { status: "ACTIVE" }) }}">On loan</a>
    {% endif %}
    </span>

    <span class="secondary-link {% if app.request.get('status') == "OVERDUE" %}active{% endif %}">
    {% if countOverdue > 0 %}
        <div class="label bg-red">{{ countOverdue }}</div> <a href="{{ path('loan_list', { status: "OVERDUE" }) }}">Overdue</a>
    {% else %}
        <div class="label bg-gray">0</div> <a href="{{ path('loan_list', { status: "OVERDUE" }) }}">Overdue</a>
    {% endif %}
    </span>

    {#<a href="{{ path('choose_member') }}" class="btn bg-green modal-link pull-right">New loan</a>#}

    {% if is_granted('ROLE_SUPER_USER') %}
        <a class="btn btn-default pull-right" href="{{ path('export_loans') }}" style="margin-right: 10px">Export</a>
    {% endif %}

{% endblock %}

{% block body %}

    <div class="row" id="primary-filter" {% if app.request.get('filtered') == 1 %}style="display:block"{% endif %}>
        <div id="primary-filter-inner">
            <form method="GET">
                <input type="hidden" name="filtered" value="1">
                <div class="col-md-11 filter-fields">
                    <div class="row">
                        <div class="col-md-2">
                            <label>Date type</label>
                            <select name="date_type" id="date_type" class="form-control">
                                <option value="date_in" {% if app.request.get('date_type') == 'date_in' %}SELECTED{% endif %}>Return due</option>
                                <option value="date_out" {% if app.request.get('date_type') == 'date_out' %}SELECTED{% endif %}>Loan start</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label>Date range</label>
                            <input type="text" id="date_picker" class="form-control date-filter">
                            <input type="hidden" name="date_from" id="date_from" value="{{ date_from }}">
                            <input type="hidden" name="date_to" id="date_to" value="{{ date_to }}">
                        </div>
                        <div class="col-md-3">
                            <label>Status</label>
                            <select class="form-control" id="status" name="status">
                                <option value=""></option>
                                {% for status in statuses %}
                                    <option {{ status.selected }} value="{{ status.id }}" {% if app.request.get('status') == status.id %}SELECTED{% endif %}>{{ status.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-1">
                    <label>&nbsp;</label>
                    <button type="submit" class="btn bg-green pull-right form-control">Filter</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12 table-responsive">
            <table cellspacing="0" class="table table-hover table-striped has-actions" id="data-table-loans">
                <thead>
                <th style="width: 30px">ID</th>
                <th style="width: 40px">Status</th>
                <th>Contact</th>
                <th>From</th>
                <th>To</th>
                <th>Fee</th>
                <th>Ref</th>
                <th></th>
                </thead>
            </table>
        </div>
    </div>
{% endblock %}

{% block pagejs %}
    <script>

        var dateFrom = "{{ date_from|date('M d Y') }}";
        var dateTo   = "{{ date_to|date('M d Y') }}";

        $(document).ready(function () {

            // https://rawgit.com/longbill/jquery-date-range-picker/master/index.html
            var datePickerField = $(".date-filter");
            datePickerField.dateRangePicker({
                format: 'MMM D YYYY',
                autoClose: true,
                selectForward: true,
                setValue: function (s) {
                    if (!$(this).attr('readonly') && !$(this).is(':disabled') && s != $(this).val()) {
                        console.log($(this).val(s));
                    }
                },
                showShortcuts: true,
                customShortcuts:
                    [
                        {
                            name: 'Today',
                            dates : function()
                            {
                                var start = moment().toDate();
                                var end   = moment().toDate();
                                return [start,end];
                            }
                        }
                    ]
            }).bind('datepicker-change', function (event, obj) {
                $("#date_from").val(moment(obj.date1).format('YYYY-MM-DD'));
                $("#date_to").val(moment(obj.date2).format('YYYY-MM-DD'));
            });

            datePickerField.data('dateRangePicker').setDateRange(dateFrom, dateTo, true);

            var dataTable = $('#data-table-loans').DataTable({
                ordering: true,
                serverSide: true,
                autoWidth: false,
                pageLength: 50,
                ajax: {
                    url: "{{ path('dt_loan_list') }}",
                    "data": function (d) {
                        return $.extend({}, d, {
                            "status": "{{ app.request.get('status') }}",
                            "date_type": "{{ app.request.get('date_type') }}",
                            "date_from": "{{ app.request.get('date_from') }}",
                            "date_to": "{{ app.request.get('date_to') }}"
                        });
                    }
                },
                "oSearch": {
                    "sSearch": "{{ searchString }}"
                },
                "language": {
                    "infoFiltered": ""
                },
                "columns": [
                    null,
                    { "orderable": false },
                    { "orderable": false },
                    null,
                    null,
                    null,
                    { "orderable": false },
                    { "orderable": false }
                ],
                "order": [[ 0, "desc" ]]
            });

            dataTable.buttons().container().appendTo('#data-table-loans_length').css('padding-right', '20px');

            {% if app.request.get('filtered') != 1 %}
            $("#data-table-loans_filter label").after('<a href="#" style="padding-left:10px;" id="show-filters">more filters</a>');
            {% endif %}

            $("#data-table-loans_filter label input").css("height", "34px");
            $("#data-table-loans_filter label input").attr("placeholder", "Contact, Loan ID, reference");
            $("#data-table-loans_filter label input").css("width", "200px");

        });
    </script>
{% endblock %}