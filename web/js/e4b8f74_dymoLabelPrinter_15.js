$(document).delegate("#printButton","click",function(event){$.getScript("/plugins/dymo/DYMO.Label.Framework_2.0Beta2.js",function(data,textStatus,jqxhr){var labelXml="";$.get(labelTemplateUrl,{id:1},function(data){labelXml=getXmlAsString(data);var imageUrl=$("#qrCodeImage").val();var itemSku=$("#product_sku").val();try{var printers=dymo.label.framework.getPrinters();if(printers.length==0)throw"No DYMO printers are installed. Install DYMO printers.";var printerName="";for(var i=0;i<printers.length;++i){var printer=printers[i];if(printer.printerType=="LabelWriterPrinter"){printerName=printer.name;break}}if(printerName==""){throw"No LabelWriter printers found. Install LabelWriter printer"}var label=dymo.label.framework.openLabelXml(labelXml);var img=new Image;img.crossOrigin="anonymous";img.onload=function(){try{var canvas=document.createElement("canvas");canvas.width=img.width;canvas.height=img.height;var context=canvas.getContext("2d");context.drawImage(img,0,0);var dataUrl=canvas.toDataURL("image/png");var pngBase64=dataUrl.substr("data:image/png;base64,".length);label.setObjectText("QR1",pngBase64);label.setObjectText("QR2",pngBase64);label.setObjectText("SKU1",itemSku);label.setObjectText("SKU2",itemSku);label.print(printerName)}catch(e){alert(e.message||e)}};img.onerror=function(){alert("Unable to load image from "+imageUrl)};img.src=imageUrl}catch(e){alert(e.message||e)}},"xml")})});function getXmlAsString(xmlDom){return typeof XMLSerializer!=="undefined"?(new window.XMLSerializer).serializeToString(xmlDom):xmlDom.xml}